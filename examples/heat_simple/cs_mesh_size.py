from core.fem.heatlinfem import heatlinfem
import core.fem.fem_util as fem
import core.util as u
import core.logic as logic
import numpy as np


Ns = [10, 20, 30, 40, 50]
Nlen = len(Ns)
L = 10.0
T = [10.0, 100.0]
dt = .1
d0s = [[T[0]] + [20.0 for i in range(N - 1)] + [T[1]] for N in Ns]

apc1 = logic.APCont([8, 9], -1, lambda x: 32.0 + (60.0 - 32.0) * (x - 8.0), lambda x: 60.0 - 32.0)
apc2 = logic.APCont([L/2, L - 1], 1, lambda x: 125, lambda x: 0)
cregions = {'A': apc1, 'B': apc2}

cspec = "(G_[1, 10] (A))"
# t \in [1,10], T = [10, 100], x \in [1, 9], N = [10, 20, 30, 40, 50], L = 10
eps = [5.2884818800547961, 1.4886301139418237, 0.675864781296589, 0.37390643814340763, 0.23786780480595837]
eta = [[ 43.61581335,  29.3081265 ,  17.55192127,  15.72098218,
        13.25545309,   9.71373527,  12.43416476,  17.43833879,
        29.26548574,  44.07015286],
       [ 20.9596702 ,  19.1568934 ,  15.80439615,  12.16137934,
        9.59742404,   8.33715418,   8.15655271,   7.77144973,
        7.09253827,   6.22468152,   5.61898297,   5.13085328,
        5.80372547,   6.69473288,   7.91083596,   9.66803934,
        12.43377018,  17.11458991,  21.79965605,  24.07977653],
       [ 16.36595727,  15.65564135,  14.06224732,  11.96591911,
        9.66747946,   7.90943556,   6.69461814,   5.80267361,
        5.459644  ,   5.30722476,   5.09255673,   4.80591063,
        4.44328133,   4.00894383,   3.51668152,   3.35805277,
        3.26872287,   3.48770456,   3.78669805,   4.14611771,
        4.58203693,   5.12061742,   5.80279234,   6.69465469,
        7.90931839,   9.66821092,  11.98903659,  14.11454786,
        15.73242549,  16.45418165],
       [ 12.22817496,  11.93156096,  11.24571964,  10.2886243 ,
        9.13794478,   7.87986416,   6.68920765,   5.80069584,
        5.11956043,   4.58113362,   4.17525938,   3.85913513,
        3.54795166,   3.48714009,   3.45573001,   3.41071652,
        3.34887954,   3.26693715,   3.16189064,   3.03144364,
        2.87444184,   2.69126266,   2.49624259,   2.64190087,
        2.81008953,   3.00309315,   3.22521672,   3.48305268,
        3.7857515 ,   4.14604562,   4.5820989 ,   5.12049109,
        5.80225131,   6.69470544,   7.90071874,   9.21318439,
        10.418954  ,  11.42526973,  12.14806588,  12.46103488],
       [  9.91873189,   9.76083403,   9.39094286,   8.86152456,
        8.20150381,   7.44521466,   6.62943039,   5.80139303,
        5.11997003,   4.5812506 ,   4.14545191,   3.78560044,
        3.48289826,   3.22512962,   3.00277986,   2.91484092,
        2.85020423,   2.7802586 ,   2.70275513,   2.61570783,
        2.51755316,   2.43721762,   2.43546188,   2.43002465,
        2.42050819,   2.40628999,   2.38654463,   2.36028255,
        2.32640398,   2.28377216,   2.23394435,   2.35410233,
        2.48835741,   2.63907072,   2.80918653,   3.00282996,
        3.22521387,   3.48307427,   3.78572821,   4.14596044,
        4.58202887,   5.12025383,   5.80271383,   6.64269215,
        7.47695445,   8.25187531,   8.92921881,   9.47318884,
        9.85356513,  10.01600912]]

nu = [
[ 0.        ,  1.56261815,  1.63770518,  0.89799818,  0.51081857,
       0.42078015,  0.66180079,  1.12257737,  1.897392  ,  1.79182204,  0.        ],
[ 0.        ,  0.93863541,  1.63273966,  1.86944789,  1.69790216,
       1.30017484,  0.9127879 ,  0.67316229,  0.51640602,  0.40858443,
       0.36039283,  0.48363727,  0.65879018,  0.84116965,  1.06085834,
       1.45248689,  1.88203844,  2.11596314,  1.87549559,  1.08640589,  0.        ],
[ 0.        ,  0.72899354,  1.3658782 ,  1.80506301,  2.00712198,
       1.98392987,  1.78693209,  1.48671767,  1.16159094,  0.91901672,
       0.74532729,  0.61643355,  0.51836204,  0.44185099,  0.44379893,
       0.45183391,  0.44102302,  0.5287199 ,  0.64462111,  0.77231573,
       0.9110461 ,  1.100726  ,  1.38746876,  1.74572877,  2.05862609,
       2.25176649,  2.25246179,  2.00916074,  1.51208301,  0.80484836,  0.        ],
[ 0.        ,  0.55822015,  1.07629613,  1.50381261,  1.81110054,
       1.98447825,  2.02655284,  1.95379468,  1.79219985,  1.57215391,
       1.32359189,  1.0954507 ,  0.92089997,  0.78539794,  0.6774498 ,
       0.59038531,  0.54016545,  0.51525799,  0.48108138,  0.44947922,
       0.45595224,  0.44955586,  0.49733489,  0.60074126,  0.70410254,
       0.80884687,  0.9161042 ,  1.02956188,  1.15677991,  1.30680482,
       1.53450118,  1.79444203,  2.01969279,  2.17924024,  2.2419011 ,
       2.1812643 ,  1.98092988,  1.63892983,  1.17018947,  0.60618787,  0.        ],
[ 0.        ,  0.39831978,  0.77791517,  1.1143266 ,  1.39081859,
       1.59599139,  1.72446782,  1.77686536,  1.75911665,  1.68129022,
       1.58732949,  1.47107167,  1.33241208,  1.18152314,  1.0314788 ,
       0.90459978,  0.79901172,  0.71044758,  0.63543657,  0.57129601,
       0.51655679,  0.46907443,  0.42777791,  0.44210357,  0.46740853,
       0.48430688,  0.49197603,  0.49007482,  0.52703413,  0.60733795,
       0.6940804 ,  0.78209543,  0.87177251,  0.96512468,  1.06468197,
       1.17349516,  1.29892165,  1.44523211,  1.63021335,  1.82646708,
       1.99745554,  2.12749926,  2.20076555,  2.20284961,  2.12249738,
       1.9532474 ,  1.69474305,  1.35348209,  0.94283173,  0.48223689,  0.        ]]

systems = [heatlinfem(N, L, T, dt) for N in Ns]
for sys in systems:
    sys.dt = dt

systemtrue = heatlinfem(1000, L, T, 0.01)
systemtrue = systemtrue.to_canon()

cstrues = [fem.build_cs(
    systemtrue, [T[0]] + [20.0 for i in range(1000 - 1)] + [T[1]],
    T, cregions, cspec, discretize_system=False) for N in Ns]

cslist = [fem.build_cs(system.to_canon(), d0, T, cregions, cspec, eps=ep, eta=et, nu=n)
          for system, d0, ep, et, n in zip(systems, d0s, eps, eta, nu)]

print "loaded cs"


# No eps
# times: [0.6001558303833008, 2.040926933288574, 4.281876087188721, 7.599426031112671, 11.859421968460083]
# results: [1.6617251024716777, -1.5667232646130744, -2.2885423308672443, -2.683509319906193, -2.7437587278861315]
# true results: [-2.7465919160148786, -2.7465919160148786, -2.7465919160148786, -2.7465919160148786, -2.7465919160148786]


# With eps
# times: [0.596095085144043, 2.010236978530884, 4.18806004524231, 7.5973639488220215, 11.549888849258423]
# results: [-3.438274897527379, -2.926723264612633, -2.91854233086724, -3.0335093199061025, -2.9437587278860633]
# true results: [-2.7465919160148786, -2.7465919160148786, -2.7465919160148786, -2.7465919160148786, -2.7465919160148786]


# with eps + eta
# times: [0.4416627883911133, 1.6518280506134033, 3.4832890033721924, 6.0745530128479, 10.204312086105347]
# results: [-32.25949964756501, -18.61264833353664, -13.337026040072942, -10.549039820125358, -9.102972605651303]
# true results: [-2.8865919315676365, -2.8865919315676365, -2.8865919315676365, -2.8865919315676365, -2.8865919315676365]


# with eps + eta + nu
# times: [0.48056888580322266, 1.6066648960113525, 3.5734119415283203, 6.27921986579895, 9.97505497932434]
# results: [-34.10410666756502, -20.608377698536742, -15.467837305072976, -12.719357828077136, -11.265646100652702]
# true results: [-2.8865919315676365, -2.8865919315676365, -2.8865919315676365, -2.8865919315676365, -2.8865919315676365]
