import unittest
from os import path

import numpy as np
from scipy import io

from .. import mech2d as mech2d
from .. import element as element


class TestMech2d(unittest.TestCase):
    def setUp(self):
        self.C = np.array([[1.346153846153846e+07, 5.769230769230769e+06, 0.000000000000000e+00],
                                  [5.769230769230769e+06, 1.346153846153846e+07, 0.000000000000000e+00],
                                  [0.000000000000000e+00, 0.000000000000000e+00, 3.846153846153846e+06]])
        self.x = np.array([12,16,16,12])
        self.y = np.array([1.0, 1.0, 2.0, 2.0])
        self.L = 16
        self.c = 2
        self.xs = np.linspace(0, self.L, 5)
        self.ys = np.linspace(0, self.c, 3)
        self.rho = 0.5


    def test_jacobian(self):
        pts = [-1/np.sqrt(3), 1/np.sqrt(3)]
        dshapes = element.BLQuadQ4.shapes_derivatives
        jac_inv, jac_det = mech2d.jacobian(dshapes, self.x, self.y)

        expected = np.array([[4.999999999999999e-01, -0.000000000000000e+00],
                             [-0.000000000000000e+00, 2.000000000000000e+00]])
        expected_det = 1.0

        for i in range(len(pts)):
            for j in range(len(pts)):
                np.testing.assert_array_almost_equal(
                    jac_inv(pts[i], pts[j]), expected, decimal=4)
                np.testing.assert_almost_equal(
                    jac_det(pts[i], pts[j]), expected_det, decimal=4)

    def test_strain_displacement(self):
        pts = [-1/np.sqrt(3), 1/np.sqrt(3)]
        dshapes = element.BLQuadQ4.shapes_derivatives
        jac_inv, jac_det = mech2d.jacobian(dshapes, self.x, self.y)
        jcob_inv = lambda a, b: np.array([[4.999999999999999e-01, -0.000000000000000e+00],
                                          [-0.000000000000000e+00, 2.000000000000000e+00]])
        strain_disp = mech2d.strain_displacement(dshapes, jcob_inv)
        expected = [[np.array([[-1.971687836487032e-01, 0.000000000000000e+00, 1.971687836487032e-01, 0.000000000000000e+00, 5.283121635129676e-02, 0.000000000000000e+00, -5.283121635129676e-02, 0.000000000000000e+00],
                               [0.000000000000000e+00, -7.886751345948131e-01, 0.000000000000000e+00, -2.113248654051871e-01, 0.000000000000000e+00, 2.113248654051871e-01, 0.000000000000000e+00, 7.886751345948131e-01],
                               [-7.886751345948131e-01, -1.971687836487032e-01, -2.113248654051871e-01, 1.971687836487032e-01, 2.113248654051871e-01, 5.283121635129676e-02, 7.886751345948131e-01, -5.283121635129676e-02]]),
                     np.array([[-5.283121635129676e-02, 0.000000000000000e+00, 5.283121635129676e-02, 0.000000000000000e+00, 1.971687836487032e-01, 0.000000000000000e+00, -1.971687836487032e-01, 0.000000000000000e+00],
                               [0.000000000000000e+00, -7.886751345948131e-01, 0.000000000000000e+00, -2.113248654051871e-01, 0.000000000000000e+00, 2.113248654051871e-01, 0.000000000000000e+00, 7.886751345948131e-01],
                               [-7.886751345948131e-01, -5.283121635129676e-02, -2.113248654051871e-01, 5.283121635129676e-02, 2.113248654051871e-01, 1.971687836487032e-01, 7.886751345948131e-01, -1.971687836487032e-01]])],
                    [np.array([[-1.971687836487032e-01, 0.000000000000000e+00, 1.971687836487032e-01, 0.000000000000000e+00, 5.283121635129676e-02, 0.000000000000000e+00, -5.283121635129676e-02, 0.000000000000000e+00],
                               [0.000000000000000e+00, -2.113248654051871e-01, 0.000000000000000e+00, -7.886751345948131e-01, 0.000000000000000e+00, 7.886751345948131e-01, 0.000000000000000e+00, 2.113248654051871e-01],
                               [-2.113248654051871e-01, -1.971687836487032e-01, -7.886751345948131e-01, 1.971687836487032e-01, 7.886751345948131e-01, 5.283121635129676e-02, 2.113248654051871e-01, -5.283121635129676e-02]]),
                     np.array([[-5.283121635129676e-02, 0.000000000000000e+00, 5.283121635129676e-02, 0.000000000000000e+00, 1.971687836487032e-01, 0.000000000000000e+00, -1.971687836487032e-01, 0.000000000000000e+00],
                               [0.000000000000000e+00, -2.113248654051871e-01, 0.000000000000000e+00, -7.886751345948131e-01, 0.000000000000000e+00, 7.886751345948131e-01, 0.000000000000000e+00, 2.113248654051871e-01],
                               [-2.113248654051871e-01, -5.283121635129676e-02, -7.886751345948131e-01, 5.283121635129676e-02, 7.886751345948131e-01, 1.971687836487032e-01, 2.113248654051871e-01, -1.971687836487032e-01]])]]

        for i in range(len(pts)):
            for j in range(len(pts)):
                np.testing.assert_array_almost_equal(
                    strain_disp(pts[i], pts[j]), expected[i][j], decimal=4)

    def test_elem_stiffness(self):
        expected = np.array([[6.250000000000003e+06, 2.403846153846154e+06, 1.442307692307694e+06, 4.807692307692308e+05, -3.125000000000001e+06, -2.403846153846154e+06, -4.567307692307697e+06, -4.807692307692308e+05],
                                    [2.403846153846154e+06, 1.826923076923078e+07, -4.807692307692308e+05, 8.653846153846158e+06, -2.403846153846154e+06, -9.134615384615388e+06, 4.807692307692308e+05, -1.778846153846155e+07],
                                    [1.442307692307694e+06, -4.807692307692308e+05, 6.250000000000003e+06, -2.403846153846154e+06, -4.567307692307696e+06, 4.807692307692307e+05, -3.125000000000001e+06, 2.403846153846154e+06],
                                    [4.807692307692308e+05, 8.653846153846158e+06, -2.403846153846154e+06, 1.826923076923078e+07, -4.807692307692308e+05, -1.778846153846155e+07, 2.403846153846154e+06, -9.134615384615388e+06],
                                    [-3.125000000000001e+06, -2.403846153846154e+06, -4.567307692307696e+06, -4.807692307692308e+05, 6.250000000000003e+06, 2.403846153846154e+06, 1.442307692307694e+06, 4.807692307692307e+05],
                                    [-2.403846153846154e+06, -9.134615384615388e+06, 4.807692307692307e+05, -1.778846153846155e+07, 2.403846153846154e+06, 1.826923076923078e+07, -4.807692307692308e+05, 8.653846153846158e+06],
                                    [-4.567307692307697e+06, 4.807692307692308e+05, -3.125000000000001e+06, 2.403846153846154e+06, 1.442307692307694e+06, -4.807692307692308e+05, 6.250000000000003e+06, -2.403846153846154e+06],
                                    [-4.807692307692308e+05, -1.778846153846155e+07, 2.403846153846154e+06, -9.134615384615388e+06, 4.807692307692307e+05, 8.653846153846158e+06, -2.403846153846154e+06, 1.826923076923078e+07]])

        np.testing.assert_array_almost_equal(
            mech2d.elem_stiffness(self.x, self.y, self.C), expected, decimal=4)

    def test_elem_mass_shape(self):
        np.testing.assert_array_equal(
            mech2d.elem_mass(self.x, self.y, 5.0).shape, (8, 8))

    def test_grid_mesh(self):
        xs = self.xs
        ys = self.ys
        expected_coords = np.array([[0.000000000000000e+00, 4.000000000000000e+00, 8.000000000000000e+00, 1.200000000000000e+01, 1.600000000000000e+01, 0.000000000000000e+00, 4.000000000000000e+00, 8.000000000000000e+00, 1.200000000000000e+01, 1.600000000000000e+01, 0.000000000000000e+00, 4.000000000000000e+00, 8.000000000000000e+00, 1.200000000000000e+01, 1.600000000000000e+01],
                                    [0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 1.000000000000000e+00, 1.000000000000000e+00, 1.000000000000000e+00, 1.000000000000000e+00, 1.000000000000000e+00, 2.000000000000000e+00, 2.000000000000000e+00, 2.000000000000000e+00, 2.000000000000000e+00, 2.000000000000000e+00]]).T
        expected_elem_nodes = np.array([[ 1,  2,  3,  4,  6,  7,  8,  9 ],
                                               [ 2,  3,  4,  5,  7,  8,  9, 10 ],
                                               [ 7,  8,  9, 10, 12, 13, 14, 15 ],
                                               [ 6,  7,  8,  9, 11, 12, 13, 14 ]]).T - 1
        mesh = mech2d.grid_mesh(xs, ys)
        np.testing.assert_array_almost_equal(mesh.nodes_coords, expected_coords)
        np.testing.assert_array_equal(mesh.elems_nodes, expected_elem_nodes)

    def test_mech2d_nobigm(self):
        force = np.array([0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, -1.796875000000000e-01, -3.000000000000000e+00, 2.656250000000000e-01, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, -2.656250000000000e-01, 0.000000000000000e+00, 5.468750000000001e-02, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, 0.000000000000000e+00, -5.468750000000001e-02])
        def g(x, y):
            if np.isclose(x, 0.0) and np.isclose(y, 0.0):
                return [0.0, 0.0]
            elif np.isclose(x, 0.0) and np.isclose(y, self.c):
                return [0.0, None]
            elif np.isclose(y, 0.0):
                return [0.0, None]
            else:
                return [None, None]


        expected = io.loadmat(path.join(
            path.dirname(path.abspath(__file__)),
            'expected/mech2d_mech2d_nobigm_bigk.mat'))['bigk']

        sosys, elems_nodes = mech2d.mech2d(self.xs, self.ys, self.rho, self.C, g, force, 1)

        self.assertEqual(sosys.K.nnz, expected.nnz)
        np.testing.assert_array_almost_equal(
            sosys.K.toarray(), expected.toarray(), decimal=4)
